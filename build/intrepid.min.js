!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global)}(this,function(exports){"use strict";var is={array:function(item){return!!(item&&item.splice&&is.callable(item.splice))},arraylike:function(item){return!!(item&&item.length&&void 0!==item[0]||is.array(item)||is.arguments(item))},arguments:function(item){return!(!item||!is.number(item.length)||"[object Arguments]"!==Object.prototype.toString.call(item))},primitive:function(item){return"object"!=typeof item},primitiveObject:function(item){return"object"==typeof item&&!!item.valueOf&&"object"!=typeof item.valueOf()},object:function(item){return"object"==typeof item},callable:function(item){return!!(item&&item.call&&item.apply)},element:function(item){return!!item.getElementsByTagName}},go={walk:function walk(obj,callback,deep,proxy,userdata,level,path,key,proxing,parent,proxyParent){var resultcb,deeper,l;if(level||(level=0,proxing=!!proxy,path=[]),level&&callback&&!1===(resultcb=proxing?callback.call(obj,obj,proxy,key,level,path,userdata,parent,proxyParent):callback.call(obj,obj,key,level,path,userdata,parent)))return!1;if(obj=parent?parent[key]:obj,proxy=proxyParent?proxyParent[key]:proxy,deeper=deep&&deep.call?proxing?deep.call(obj,obj,proxy,key,level,path,userdata,parent,proxyParent):deep.call(obj,obj,key,level,path,userdata,parent):!0===deep||deep<level,!level||deeper)switch(!0){case is.array(obj):for(key=0,l=obj.length;key<l;key++)if(!1===walk(obj[key],callback,deep,proxy&&proxy[key],userdata,level+1,path.concat([key]),key,proxing,obj,proxy))return!1;break;case is.object(obj):for(key in obj)if((!Object.prototype.hasOwnProperty||Object.prototype.hasOwnProperty.call(obj,key))&&!1===walk(obj[key],callback,deep,proxy&&proxy[key],userdata,level+1,path.concat([key]),key,proxing,obj,proxy))return!1}return resultcb&&is.callable(resultcb)&&resultcb.call(),null},merge:function(a){return a},_createDerefFunction:function(m){return function(){return m.apply(this,arguments)}},_createAssignableObject:function(o){return is.primitive(o)||is.primitiveObject(o)?new(Object.getPrototypeOf(o).constructor)(o):is.callable(o)?this._createDerefFunction(o):is.array(o)?o.slice(0):Object.create(o)},_derefWithTemplate:function(){function drefTemplateError(msg){this.message=msg,"captureStackTrace"in Error?Error.captureStackTrace(this,drefTemplateError):this.stack=(new Error).stack}return drefTemplateError.prototype=new Error,function(obj,proxy,key,level,path,ud,parent,proxyParent){if(void 0===proxy)throw new drefTemplateError("deref template incorrectly defined for "+path.join("."));try{proxyParent[key]=obj.call?obj.call(proxy,proxy):ud.method(proxy)}catch(ex){throw ex instanceof drefTemplateError?ex:new drefTemplateError(ex+" : deref template incorrectly defined for "+path.join("."))}}}(),deref:function(obj,template,method){var ret=Object.create(obj),createAssignableObject=this._createAssignableObject;return template&&go.walk(template,this._derefWithTemplate,!0,ret,{method:method||createAssignableObject}),ret},derefAssign:function(obj,template){var createAssignableObject=this._createAssignableObject;return this.deref(obj,template,function(obj){return Object.assign(createAssignableObject(obj),obj)})}},intrepid=function(){return intrepid.instance.create.apply(intrepid.instance,arguments)};return intrepid.base={create:function(target){return this.prep.apply(Object.create(this),arguments)},prep:function(){return this},namespace:function(){return go.derefAssign(this,this.shared&&this.shared.namespaceTemplate)},extend:function(props){return Object.assign(Object.create(this),props||{})},proto:function(){return Object.getPrototypeOf(this)},config:function(snowball,depth){if(!depth)return this.namespace().config(!0===snowball?this:{},1);var keys,key,a,i,l;if(snowball.endConfig||(snowball.endConfig=function(){return this},snowball.endConfig=snowball.endConfig.bind(this)),this.shared&&this.shared.configMethods)for(a=this.shared.configMethods,i=0,l=(keys=Object.keys(a)).length,i;i<l;i++)snowball[key=keys[i]]=function(m,mc,rc){return function(){return m.apply(mc,arguments),rc}}(this[key],this,snowball);if(this.helpers)for(a=this.helpers,i=0,l=(keys=Object.keys(a)).length,i;i<l;i++)a[key=keys[i]]&&a[key].config&&a[key].config(snowball,depth+1);return snowball}},intrepid.queryInterface=intrepid.base.extend({shared:{segments:{},namespaceTemplate:{}},prep:function(selector){return this.i={},this.i.current=0,this.i.segments=this.process(selector),this},__andList:function(){return[]},__orList:function(){return[]},process:function(selector){throw new Error("This function should be overridden, and is responsible for returning an array of filter functions.")},reset:function(){return this.i.current=0,this},next:function(){if(this.i.current<this.i.segments.length){var item=this.i.segments[this.i.current];return this.i.current++,item}return null},length:function(){return this.i.segments?this.i.segments.length:0}}),function(qi,segments){segments.base={extend:function(props){return Object.assign(Object.create(this),props||{})}},segments.matcher=segments.base.extend({}),segments.directive=segments.base.extend({}),segments.combination=segments.base.extend({create:function(){return this.prep.apply(Object.create(this),arguments)},prep:function(items){return this.i={},this.i.list=items,this},apply:function(methods){for(var item,a=this.i.list,i=0,l=a.length;i<l;i++)item=a[i],segments.directive.isPrototypeOf(item)?methods.setDirective(item):segments.matcher.isPrototypeOf(item)?methods.setMatcher(item):segments.combination.isPrototypeOf(item)?item.apply(methods):methods.setSegment(item);return this},each:function(callback,context){for(var a=this.i.list,i=0,l=a.length;i<l;i++)callback.call(context||this,a[i])},toString:function(){return"[QueryInterface combination( "+this.i.list+" )]"}}),qi.isDirective=function(v){return segments.directive.isPrototypeOf(v)},qi.isMatcher=function(v){return segments.matcher.isPrototypeOf(v)},qi.isCombination=function(v){return segments.combination.isPrototypeOf(v)},segments.matchAnyAndNone=segments.matcher.extend({toString:function(){return"[QI matchAnyAndNone]"}}),segments.matchNext=segments.matcher.extend({toString:function(){return"[QI matchNext]"}}),segments.goDescend=segments.directive.extend({toString:function(){return"[QI goDescend]"}}),segments.goAscend=segments.directive.extend({toString:function(){return"[QI goAscend]"}}),segments.matchAny=segments.combination.create([segments.matchNext,function(v,k,p){return!0}]),segments.matchParent=segments.combination.create([segments.goAscend,segments.matchAny]),segments.matchAncestor=segments.combination.create([segments.goAscend,segments.matchAnyAndNone])}(intrepid.queryInterface,intrepid.queryInterface.shared.segments),intrepid.dataHandlers=intrepid.base.extend({shared:{handlers:{byName:{},byList:[],inOrder:[]},filtered:{byName:{},byList:[],inOrder:[]},namespaceTemplate:{shared:{handlers:{byName:{},byList:[],inOrder:[]},filtered:{byName:{},byList:[],inOrder:[]},namespaceTemplate:{},configMethods:{}}},configMethods:{dataHandlers:!0}},dataHandlers:function(names){var filtered=this.shared.filtered,handlers=this.shared.handlers;filtered.byName={},filtered.byList=[],filtered.inOrder=[],arguments.length>1?names=arguments:"string"==typeof arguments[0]&&(names=[arguments[0]]);var i,l,name,handler,a=names;for(i=0,l=a.length;i<l;i++)(name=a[i])&&handlers.byName[name]&&(handler=handlers.byName[name],filtered.byName[name]=handler,filtered.byList.push(handler),filtered.inOrder.push(handler));return this},getHandlersOrderedByWeight:function(){var a=this.shared.handlers.byList.slice();a.length;return a.sort(function(a,b){return a.weight>b.weight?1:a.weight<b.weight?-1:0})},choose:function(ref){var item,s=this.shared,a=s.filtered.inOrder||s.handlers.inOrder,i=0,l=a.length;for(i;i<l;i++)if((item=a[i]).obj.validation(ref)>0)return item.obj;return item.obj},add:function(name,weight,obj){var item={name:name,weight:weight,obj:obj};return obj.join=function(from,by,to){return new intrepid.join(from,by,to)},this.shared.handlers.byName[name]=item,this.shared.handlers.byList.push(item),this.shared.handlers.inOrder=this.getHandlersOrderedByWeight(),this}}),intrepid.join=function join(from,by,to){return this instanceof join?(this.shared.store.set(this,{from:from,by:by,to:to}),this):new join(from,by,to)},intrepid.join.prototype.shared={store:new WeakMap},intrepid.join.prototype.from=function(){return this.shared.store.get(this).from},intrepid.join.prototype.by=function(){return this.shared.store.get(this).by},intrepid.join.prototype.to=function(){return this.shared.store.get(this).to},intrepid.join.prototype.join=function(by,to){return new intrepid.join(this,by,to)},intrepid.join.prototype.toString=function(){return"[ intrepid Join "+this.by()+" ]"},intrepid.targetReference=intrepid.base.extend({shared:{namespaceTemplate:{shared:{namespaceTemplate:{}},helpers:{dataHandlers:function(o){return o.namespace()}}}},helpers:{dataHandlers:intrepid.dataHandlers,join:intrepid.join},prep:function(target,key,parent){return this.i={},target instanceof this.helpers.join?this.i.join=target:this.i.join=this.helpers.join(parent,key,target),this.i.handler=this.helpers.dataHandlers.choose(this),this},attribute:function(){if(this.i.handler.hasAttributes(this)&&this.i.handler.hasAttribute(this,filter)){var attr=this.i.handler.parent(this,filter);if(attr)return this.create(attr)}return null},attributes:function(){if(this.i.handler.hasAttributes(this)){var attrs=this.i.handler.children(this,filter);if(attrs&&attrs.length)return this.wrap(attrs)}return[]},children:function(filter){if(this.i.handler.hasChildren(this)){var kids=this.i.handler.children(this,filter);if(kids&&kids.length)return this.wrap(kids)}return[]},parent:function(filter){if(this.i.handler.hasParent(this)){var parent=this.i.handler.parent(this,filter);if(parent)return this.create(parent)}return null},filter:function(filter){return this.i.handler.filter(this,filter)?this:null},test:function(){for(var target=this.get(),a=arguments,i=0,l=a.length;i<l;i++)if(a[i]&&a[i].call&&a[i](target))return!0;return!1},get:function(){return this.i.join.to()},getKey:function(){return this.i.join.by()},getParent:function(){return this.i.join.from()},joinChild:function(by,to){return this.i.join.join(by,to)},wrap:function(list){if(!list)return[];if(is.array(list)){for(var relist=[],i=0,l=list.length;i<l;i++)relist.push(this.wrapItem(list[i]));return relist}return[this.wrapItem(list)]},wrapItem:function(item){return this.isPrototypeOf(item)?item:this.create(item)}}),intrepid.uniqueList=intrepid.base.extend({shared:{namespaceTemplate:{shared:{namespaceTemplate:{},config:{},configMethods:{}}},config:{comparisonEntity:function(v){return v}},configMethods:{comparisonEntity:!0}},create:function(){return this.prep.apply(Object.create(this),arguments)},prep:function(){return this.i={},this.i.items=[],this.i.comparisons={objects:new WeakMap,primitives:{keys:[],vals:[]}},this},push:function(v){var ce=this.shared.config.comparisonEntity(v);ce===v?-1===this.i.items.indexOf(v)&&this.i.items.push(v):is.primitive(ce)?-1===this.i.comparisons.primitives.keys.indexOf(ce)&&(this.i.comparisons.primitives.keys.push(ce),this.i.comparisons.primitives.vals.push(this.i.items.length),this.i.items.push(v)):this.i.comparisons.objects.has(ce)||(this.i.comparisons.objects.set(ce,this.i.items.length),this.i.items.push(v))},get:function(n){return arguments.length?this.i.items[n]:this.i.items},comparisonEntity:function(m){return this.shared.config.comparisonEntity=m,this}}),intrepid.cursorObject=intrepid.base.extend({shared:{namespaceTemplate:{shared:{namespaceTemplate:{}},helpers:{targetReference:function(o){return o.namespace()}}},config:{allowDuplicates:!1},configMethods:{allowDuplicates:!0,disallowDuplicates:!0}},helpers:{targetReference:intrepid.targetReference,uniqueList:intrepid.uniqueList.config().comparisonEntity(function(v,list){return v||console.trace(),v.get()}).endConfig()},allowDuplicates:function(){return this.shared.config.allowDuplicates=!0,this},disallowDuplicates:function(){return this.shared.config.allowDuplicates=!1,this},prep:function(){return this.i={},this.i.targets,this},chain:function(){var instance=this.create();return instance.i.targets=this.i.targets,instance},_createList:function(){return this.shared.config.allowDuplicates?[]:this.helpers.uniqueList.create()},empty:function(){return this.i.targets=[],this},target:function(target){return arguments.length?(this.i.targets=[this.helpers.targetReference.create(target)],this):this.i.targets[0]||null},targets:function(targets){return arguments.length?(this.helpers.uniqueList.isPrototypeOf(targets)&&(targets=targets.get()),this.i.targets=this.helpers.targetReference.wrap(targets),this):this.i.targets},children:function(filter){var a,i,l,aa,ii,ll,list=this._createList();for(i=0,l=(a=this.i.targets).length;i<l;i++)for(ii=0,ll=(aa=a[i].children(filter)).length;ii<ll;ii++)list.push(aa[ii]);return this.create().targets(list)},parent:function(filter){var a,i,l,p,list=this._createList();for(i=0,l=(a=this.i.targets).length;i<l;i++)(p=a[i].parent(filter))&&list.push(p);return this.create().targets(list)},filter:function(filter){var a,i,l,f,list=this._createList();for(i=0,l=(a=this.i.targets).length;i<l;i++)(f=a[i].filter(filter))&&list.push(f);return this.create().targets(list)},get:function(n){return arguments.length?n<this.i.targets.length?this.i.targets[n].get():null:this.getArray()},getArray:function(){var a,i,l,list=[];for(i=0,l=(a=this.i.targets).length;i<l;i++)list.push(a[i].get());return list},add:function(item){return this.isPrototypeOf(item)&&(this.i.targets=this.i.targets.concat(item.i.targets)),this},length:function(){return this.i.targets?this.i.targets.length:0}}),intrepid.instance=intrepid.base.extend({shared:{namespaceTemplate:{shared:{namespaceTemplate:{}},helpers:{queryInterface:function(o){return o.namespace()},cursorObject:function(o){return o.namespace()}}}},helpers:{queryInterface:intrepid.queryInterface,cursorObject:intrepid.cursorObject},prep:function(target,options){return this.i={},this.prepCursor(target),this.prepChained(options),this},prepCursor:function(target){return this.helpers.cursorObject.isPrototypeOf(target)?this.i.cursor=target:target&&(this.i.cursor=this.helpers.cursorObject.create().target(target)),this},prepChained:function(options){var chained=this.i.chained=this.i.chained?go.derefAssign(this.i.chained):{};return chained.handlers||(chained.handlers=[]),chained.stored||(chained.stored=[]),chained.options||(chained.options={}),options&&go.merge(chained.options,options),this},chain:function(target){return this.create(void 0!==target?target:this.i.cursor.chain())},extend:function(props){return Object.assign(Object.create(this),props||{}).prep(null)},options:function(){return arguments.length?(go.merge(this.i.chained.options,arguments[0]),this):this.chained.options},each:function(callback,context){return this.i.cursor.each.apply(this.i.cursor,arguments),this},children:function(filter){return this.chain(this.i.cursor.children(filter))},parent:function(filter){return this.chain(this.i.cursor.parent(filter))},find:function(selector){for(var finds,scout,cursor=this.i.cursor.chain(),segment=selector.reset(),qi=this.helpers.queryInterface,qis=qi.shared.segments,match=qis.matchAnyAndNone,method=qis.goDescend,setDirective=function(s){method=s},setMatcher=function(s){match=s},setSegment=function(s){segment=s};segment=selector.next();)if(segment.call||(qi.isCombination(segment)?segment.apply({setMatcher:setMatcher,setDirective:setDirective,setSegment:setSegment}):qi.isDirective(segment)?setDirective(segment):qi.isMatcher(segment)&&setMatcher(segment)),console.log("####",""+segment,""+match,""+method),segment.call)if(method===qis.goDescend)if(match===qis.matchAnyAndNone){scout=cursor.children(),cursor.empty();do{(finds=scout.filter(segment)).length()&&cursor.add(finds),scout=scout.children()}while(scout.length())}else match===qis.matchNext&&(cursor=cursor.children(segment));else if(method===qis.goAscend)if(match===qis.matchAnyAndNone){scout=cursor.parent(),cursor.empty();do{(finds=scout.filter(segment)).length()&&cursor.add(finds),scout=scout.parent()}while(scout.length())}else match===qis.matchNext&&(cursor=cursor.parent(segment));return this.chain(cursor)},get:function(n){return this.i.cursor.get.apply(this.i.cursor,arguments)},log:function(){return console.log(this.get()),this},getCursor:function(){return this.i.cursor}}),intrepid.simpleQuery=intrepid.queryInterface.extend({process:function(selector){var list=[];"/"!=selector[0]&&selector.unshift("**");for(var i=0,a=selector,l=a.length;i<l;i++)this.handleSegment(a[i],list);return list},handleSegment:function(segment,list){switch(segment){case"**":list.push(this.shared.segments.matchAnyAndNone);break;case"*":list.push(this.shared.segments.matchAny);break;case"/":list.push(this.shared.segments.matchNext);break;case"..":list.push(this.shared.segments.matchParent),list.push(this.shared.segments.goDescend);break;case"...":list.push(this.shared.segments.matchAncestor);break;default:switch(!0){case"@"==segment.charAt(0):break;default:var item=function(val,key,par){return key===segment};item.toString=function(){return"[SimpleQuery Match "+segment+"]"},list.push(item),list.push(this.shared.segments.matchNext),list.push(this.shared.segments.goDescend)}}}}),intrepid.dataHandlers.add("obj",1e3,{validation:function(ref){return"object"==typeof ref.get()&&1},filter:function(ref,filter){return filter(ref.get(),ref.getKey(),ref.getParent())},hasAttribute:function(ref,attr,valuehj){},attribute:function(ref,attr,value){},hasChildren:function(ref){return!!ref.test(is.object,is.array)&&Object.keys(ref.get()).length},children:function(ref,filter){if(ref.test(is.object,is.array)){var i,key,val,target=ref.get(),keys=Object.keys(target),l=keys.length,list=[];for(i=0;i<l;i++)val=target[key=keys[i]],filter&&!filter(val,key)||list.push(ref.joinChild(key,val));return list}return ref.test(is.primitive),[]},hasParent:function(ref){return!!ref.getParent()},parent:function(ref){return ref.getParent()},needsResolving:function(){},resolve:function(){},processParents:function(){},processChildren:function(){}}),intrepid.dataHandlers.add("dom",500,{validation:function(ref){var o=ref.get();return o&&o.nodeName?1:0},matchKey:function(){},matchValue:function(){},matchAttr:function(){},hasChildren:function(){},children:function(){},filter:function(){},hasParent:function(){},parent:function(){},needsResolving:function(){},resolve:function(){},processParents:function(){},processChildren:function(){}}),intrepid.objNav=intrepid().config().dataHandlers("obj").disallowDuplicates().endConfig(),exports.intrepid=intrepid});